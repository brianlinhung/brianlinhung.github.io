<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>VIP å°ˆå±¬é ç´„</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: sans-serif; background: #FDFBF7; padding: 20px; color: #4A4A4A; margin: 0; }
    .container { max-width: 400px; margin: 0 auto; background: #FFF; padding: 30px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
    h2 { text-align: center; color: #B59B7D; font-weight: 300; letter-spacing: 1px; }
    label { display: block; margin-top: 15px; font-size: 14px; color: #666; }
    input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #E0E0E0; border-radius: 6px; box-sizing: border-box; background: #FAFAFA; font-size: 16px;}
    
    /* æ™‚æ®µæŒ‰éˆ• */
    .slot-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
    .slot-btn { padding: 10px; border: 1px solid #B59B7D; color: #B59B7D; border-radius: 6px; text-align: center; cursor: pointer; transition: 0.2s; }
    .slot-btn.selected { background: #B59B7D; color: #FFF; }
    
    /* æŒ‰éˆ•æ¨£å¼ */
    .btn-submit { width: 100%; padding: 15px; background: #B59B7D; color: white; border: none; border-radius: 6px; margin-top: 25px; font-size: 16px; cursor: pointer; }
    .btn-submit:disabled { background: #D3C9BE; cursor: not-allowed; }

    /* æˆåŠŸè¨Šæ¯å€å¡Š (é è¨­éš±è—) */
    #success-view { display: none; text-align: center; padding: 20px 0; }
    .check-icon { font-size: 60px; color: #B59B7D; margin-bottom: 20px; }
    .success-text { font-size: 18px; line-height: 1.6; color: #4A4A4A; }
    .small-text { font-size: 14px; color: #999; margin-top: 10px; }
  </style>
</head>
<body>

  <div class="container">
    
    <div id="form-view">
      <h2>å°ˆå±¬é ç´„</h2>
      <form id="bookingForm">
        <input type="hidden" id="userId">
        
        <label>å§“å</label>
        <input type="text" id="name" placeholder="è«‹è¼¸å…¥å§“å">
        
        <label>é›»è©±</label>
        <input type="tel" id="phone" placeholder="09XX-XXX-XXX">
        
        <label>æœå‹™é …ç›®</label>
        <select id="service">
          <option>è¼‰å…¥ä¸­...</option>
        </select>
        
        <label>é ç´„æ—¥æœŸ</label>
        <input type="date" id="date" onchange="loadSlots()">
        
        <label>é¸æ“‡æ™‚æ®µ</label>
        <div id="slotContainer" class="slot-grid">è«‹å…ˆé¸æ“‡æ—¥æœŸ</div>
        <input type="hidden" id="time">

        <button type="button" class="btn-submit" id="submitBtn" onclick="submitForm()">ç¢ºèªé ç´„</button>
      </form>
    </div>

    <div id="success-view">
      <div class="check-icon">âœ¨</div>
      <div class="success-text">
        <b>æ„Ÿè¬æ‚¨é ç´„ï¼</b><br>
        æ‚¨çš„é ç´„ç”³è«‹å·²é€å‡ºã€‚<br>
        ç¾ç«å¸«å°‡ç›¡å¿«ç¢ºèªæ‚¨çš„æ™‚æ®µã€‚
      </div>
      <div class="small-text">
        æ‚¨å°‡åœ¨ LINE æ”¶åˆ°ç¢ºèªé€šçŸ¥ã€‚<br>
        æœŸå¾…èˆ‡æ‚¨ç›¸è¦‹ ğŸ’•
      </div>
      <button onclick="liff.closeWindow()" class="btn-submit" style="margin-top:30px;">é—œé–‰è¦–çª—</button>
    </div>

  </div>

<script>
    // âš ï¸ è«‹å¡«å…¥æ‚¨çš„è¨­å®š
    const LIFF_ID = "2009213230-eIOOHDEU";
    // âš ï¸ éƒ¨ç½² GAS Web App å¾Œï¼Œå°‡ç¶²å€è²¼åœ¨é€™è£¡
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwMVhXrDJxoeAPcekAT-grAGygL7ZProkW1tqoV1iotKgD38Xr0k19lrUGAzyo2rp3c/exec";

    let currentUserId = "";

    window.onload = function() {
      initializeLiff();
    };

    async function initializeLiff() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        const profile = await liff.getProfile();
        currentUserId = profile.userId;
        document.getElementById('userId').value = profile.userId;
        console.log("IDæŠ“å–æˆåŠŸ: " + currentUserId);
      } catch (err) {
        console.error("LIFF åˆå§‹åŒ–å¤±æ•—:", err);
        alert("LIFF åˆå§‹åŒ–å¤±æ•—: " + err + "\nè«‹ç¢ºèªæ˜¯å¦ä½¿ç”¨æ‰‹æ©Ÿ LINE é–‹å•Ÿã€‚");
      }

      // è¼‰å…¥æœå‹™é …ç›®
      try {
        const res = await fetch(GAS_API_URL + '?action=getServiceList');
        const services = await res.json();
        const select = document.getElementById('service');
        select.innerHTML = '';
        services.forEach(s => {
          let opt = document.createElement('option');
          opt.value = s;
          opt.innerText = s;
          select.appendChild(opt);
        });
      } catch (err) {
        console.error("è¼‰å…¥æœå‹™é …ç›®å¤±æ•—:", err);
      }
    }

    // è¼‰å…¥æ™‚æ®µ
    async function loadSlots() {
      const date = document.getElementById('date').value;
      const container = document.getElementById('slotContainer');
      container.innerHTML = '<div style="grid-column:span 3; text-align:center; color:#999;">æŸ¥è©¢ä¸­...</div>';

      try {
        const res = await fetch(GAS_API_URL + '?action=getAvailableSlots&date=' + encodeURIComponent(date));
        const slots = await res.json();
        container.innerHTML = '';
        if (slots.length === 0) {
          container.innerHTML = '<div style="grid-column:span 3; text-align:center; color:red;">è©²æ—¥å·²ç„¡ç©ºæª”æˆ–æœªé–‹æ”¾</div>';
          return;
        }
        slots.forEach(t => {
          let div = document.createElement('div');
          div.className = 'slot-btn';
          div.innerText = t;
          div.onclick = function() {
            document.querySelectorAll('.slot-btn').forEach(b => b.classList.remove('selected'));
            this.classList.add('selected');
            document.getElementById('time').value = t;
          };
          container.appendChild(div);
        });
      } catch (err) {
        container.innerHTML = '<div style="grid-column:span 3; text-align:center; color:red;">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡è©¦</div>';
      }
    }

    // é€å‡ºè¡¨å–®
    async function submitForm() {
      const finalUid = currentUserId || document.getElementById('userId').value;

      if (!finalUid) {
        alert("âŒ ç³»çµ±å°šæœªæŠ“åˆ°æ‚¨çš„ LINE è³‡æ–™\n\nè«‹ç¢ºèªï¼š\n1. æ˜¯å¦ä½¿ç”¨æ‰‹æ©Ÿ LINE é–‹å•Ÿï¼Ÿ\n2. ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸ï¼Ÿ\n\nè«‹é‡æ–°æ•´ç†é é¢å†è©¦ä¸€æ¬¡ã€‚");
        liff.login();
        return;
      }

      const data = {
        action: 'processBooking',
        userId: finalUid,
        name: document.getElementById('name').value,
        phone: document.getElementById('phone').value,
        service: document.getElementById('service').value,
        date: document.getElementById('date').value,
        time: document.getElementById('time').value
      };

      if (!data.name || !data.phone || !data.date || !data.time) return alert("è«‹å®Œæ•´å¡«å¯«è³‡æ–™");

      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.innerText = "è™•ç†ä¸­...";

      try {
        const response = await fetch(GAS_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify(data)
        });
        const res = await response.json();
        if (res.status === 'success') {
          document.getElementById('form-view').style.display = 'none';
          document.getElementById('success-view').style.display = 'block';
        } else {
          alert(res.message);
          btn.disabled = false;
          btn.innerText = "ç¢ºèªé ç´„";
          loadSlots();
        }
      } catch (err) {
        alert("é€å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦");
        btn.disabled = false;
        btn.innerText = "ç¢ºèªé ç´„";
      }
    }
  </script>
</body>
</html>